import groovy.json.JsonSlurper


node {
    def rootDir = pwd()
    def productConfig

    stage("Setting repo checkout") {
        checkout scmGit(
            branches: [[name: 'develop/1.1.1']],
            userRemoteConfigs: [[url: 'https://github.com/lemonfisk/NEMEZIDA.git']])
    }

    stage('Build') {
        productConfig = readYaml (file: "job-dsl/SAST_config.yml")
    }

    stage('Get product version and default branch products') {
        productConfig.each { productKey, productValue ->
            println "product_key - ${productKey} - ${productValue}"
            println "product_git_url - ${productValue.product_git_url}"
            def defaultBranchOutput = sh(returnStdout: true, script: "git ls-remote --symref ${productValue.product_git_url} HEAD").trim()
            println "defaultBranchOutput - ${defaultBranchOutput}"

            def defaultBranch = defaultBranchOutput.tokenize('refs/heads/')[1]
            //.tokenize(' HEAD')[0]
            println "defaultBranch - ${defaultBranch}"

            //def version = defaultBranch.tokenize('/')[1] // Получение версии из ветки



            //def defaultBranch = defaultBranchOutput.tokenize("\t")[1].tokenize("/").last()
            //println "defaultBranch - ${defaultBranch}"
            //def version = defaultBranch.tokenize('/')[2] // Получение версии из ветки
            //println "version - ${version}"










        }
    }





    stage('Test') {
        println "productConfig -----${productConfig}"
    }
}