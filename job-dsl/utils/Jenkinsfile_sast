import groovy.json.JsonSlurper


node {
    def rootDir = pwd()
    def productConfig

    stage("Setting repo checkout") {
        checkout scmGit(
            branches: [[name: 'develop/1.1.1']],
            userRemoteConfigs: [[url: 'https://github.com/lemonfisk/NEMEZIDA.git']])
    }

    stage('Build') {
        productConfig = readYaml (file: "job-dsl/SAST_config.yml")
    }

    stage('Get product version and default branch products') {
        productConfig.each { productKey, productValue ->
            def git_url = productValue.product_git_url
            def defaultBranchOutput = sh(script: "curl -s ${git_url} | grep '\"default_branch\"'", returnStdout: true).trim()
            def defaultBranch = defaultBranchOutput.replaceAll(/.*": "(.*?)".*/, '$1')
            println "defaultBranch - ${defaultBranch}"
            def product_version = defaultBranchOutput.replaceAll(/.*\/([^\"]+)".*/, '$1')
            println "product_version - ${product_version}"
            productConfig["${productKey}"]["product_version"] = "${product_version}"

        }
    }





    stage('Test') {
        println "productConfig -----${productConfig}"
    }
}